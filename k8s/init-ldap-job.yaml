apiVersion: batch/v1
kind: Job
metadata:
  name: ldap-init
  namespace: data-resolver
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-ldap
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          echo "Waiting for LDAP service to be available..."
          # Bitnami LDAP uses port 1389
          until nc -z ldap 1389; do
            echo "LDAP not ready, waiting..."
            sleep 2
          done
          echo "LDAP service is ready"
      containers:
      - name: ldap-seed
        # Using same Bitnami image as LDAP server
        image: public.ecr.aws/bitnami/openldap:2.6
        command:
        - sh
        - -c
        - |
          set -e
          echo "Checking if users already exist..."
          # Bitnami LDAP uses port 1389
          if ldapsearch -x -H ldap://ldap:1389 -b dc=example,dc=com -D 'cn=admin,dc=example,dc=com' -w admin "(uid=alice)" 2>/dev/null | grep -q "^dn: uid=alice"; then
            echo "Users already exist, skipping import"
          else
            echo "Importing seed data..."
            ldapadd -x -H ldap://ldap:1389 -D "cn=admin,dc=example,dc=com" -w admin -f /seed-data/users.ldif
            echo "Seed data imported successfully"
          fi
        volumeMounts:
        - name: seed-data
          mountPath: /seed-data
      volumes:
      - name: seed-data
        configMap:
          name: ldap-seed-data
