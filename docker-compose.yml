version: "3.9"

services:
  ldap:
    # Using Bitnami image from AWS ECR Public to avoid Docker Hub rate limits
    # Alternative: osixia/openldap:1.5.0 (may hit rate limits)
    image: public.ecr.aws/bitnami/openldap:2.6
    container_name: test-ldap
    environment:
      LDAP_ROOT: "dc=example,dc=com"
      LDAP_ADMIN_USERNAME: "admin"
      LDAP_ADMIN_PASSWORD: "admin"
    ports:
      # Using non-privileged port to avoid needing root on Linux
      - "33389:389"
    healthcheck:
      test: ["CMD-SHELL", "ldapsearch -x -H ldap://localhost:389 -b dc=example,dc=com -D 'cn=admin,dc=example,dc=com' -w admin"]
      interval: 5s
      timeout: 3s
      retries: 10

  ldap-admin:
    image: osixia/phpldapadmin:0.9.0
    container_name: ldap-admin
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: ldap
      PHPLDAPADMIN_HTTPS: "false"
    ports:
      - "8080:80"
    depends_on:
      - ldap

  resolver:
    build: .
    container_name: data-owner-resolver
    environment:
      LDAP_URL: ldap://ldap:389
      LDAP_BIND_DN: cn=admin,dc=example,dc=com
      LDAP_BIND_PASS: admin
      LDAP_BASE_DN: dc=example,dc=com
      LDAP_STARTTLS: "false"
      LDAP_SKIP_TLS_VERIFY: "false"
    # NOTE: No volume mount here (testdata is baked into image with correct ownership)
    # Linux users: Create docker-compose.override.yml to add volume mount for live editing
    # See docker-compose.override.yml.example
    depends_on:
      ldap:
        condition: service_healthy